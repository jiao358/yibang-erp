# 后端迁移和切换使用说明

## 概述

本系统提供了完整的后端服务迁移和切换解决方案，支持：

- **无缝迁移**：在不中断服务的情况下迁移后端
- **负载均衡**：通过Nginx实现多后端负载均衡
- **动态切换**：前端可以动态切换后端端口
- **优雅关闭**：支持后端服务的优雅关闭
- **健康检查**：自动检查后端服务健康状态
- **高可用部署**：支持主备模式部署

## 脚本说明

### 1. start-backend-migration.sh - 后端迁移管理脚本

**功能**：
- 多端口后端实例管理
- 负载均衡配置
- 服务迁移和回滚
- 优雅关闭管理

**主要命令**：
```bash
./start-backend-migration.sh start-primary [环境]    # 启动主服务
./start-backend-migration.sh start-backup [环境]     # 启动备份服务
./start-backend-migration.sh migrate [环境]          # 执行迁移
./start-backend-migration.sh complete                # 完成迁移
./start-backend-migration.sh rollback                # 回滚迁移
./start-backend-migration.sh stop-all                # 停止所有服务
./start-backend-migration.sh status                  # 查看状态
```

### 2. switch-backend.sh - 后端切换脚本

**功能**：
- 动态切换前端API端点
- 自动健康检查
- 配置备份和回滚
- 热重载支持

**主要命令**：
```bash
./switch-backend.sh [端口] [环境]                    # 切换到指定端口
./switch-backend.sh status                           # 查看当前配置
./switch-backend.sh test [端口]                      # 测试后端连接
./switch-backend.sh test-all [端口1] [端口2]         # 批量测试端口
./switch-backend.sh rollback [备份名]                # 回滚配置
./switch-backend.sh list-backups                     # 列出备份
```

### 3. start-advanced.sh - 高级启动脚本

**功能**：
- 统一管理所有启动脚本
- 支持标准模式和高可用模式
- 完整的服务生命周期管理
- 实时监控功能

**主要命令**：
```bash
./start-advanced.sh start-standard [环境]           # 启动标准模式
./start-advanced.sh start-ha [环境]                 # 启动高可用模式
./start-advanced.sh migrate [环境]                  # 执行迁移
./start-advanced.sh switch [端口] [环境]            # 切换后端
./start-advanced.sh status                          # 查看状态
./start-advanced.sh monitor                         # 监控服务
```

## 使用场景

### 场景1：后端服务迁移

当后端服务出现问题需要迁移时：

```bash
# 1. 启动主服务和备份服务
./start-backend-migration.sh start-primary dev
./start-backend-migration.sh start-backup dev

# 2. 执行迁移（启动新服务并切换流量）
./start-backend-migration.sh migrate dev

# 3. 完成迁移（停止旧服务）
./start-backend-migration.sh complete
```

### 场景2：动态切换后端

当需要临时切换到其他后端时：

```bash
# 切换到端口7103
./switch-backend.sh 7103 dev

# 查看当前配置
./switch-backend.sh status

# 回滚到之前的配置
./switch-backend.sh rollback dev_20240101_120000
```

### 场景3：高可用部署

启动高可用模式：

```bash
# 启动高可用模式
./start-advanced.sh start-ha dev

# 查看状态
./start-advanced.sh status

# 监控服务
./start-advanced.sh monitor
```

## 详细使用指南

### 1. 后端迁移流程

#### 步骤1：启动主服务
```bash
./start-backend-migration.sh start-primary dev
```
- 在默认端口7102启动主后端服务
- 自动检查Java环境和构建应用
- 验证服务健康状态

#### 步骤2：启动备份服务
```bash
./start-backend-migration.sh start-backup dev
```
- 自动分配可用端口（如7103）
- 启动备份后端服务
- 保存端口信息到backup.port文件

#### 步骤3：执行迁移
```bash
./start-backend-migration.sh migrate dev
```
- 启动迁移服务（如端口7104）
- 配置Nginx负载均衡
- 更新前端配置
- 将流量切换到新服务

#### 步骤4：完成迁移
```bash
./start-backend-migration.sh complete
```
- 停止旧的主服务
- 将迁移服务设为主服务
- 清理临时文件

### 2. 动态切换流程

#### 切换到新后端
```bash
./switch-backend.sh 7103 dev
```
- 检查目标后端健康状态
- 备份当前前端配置
- 更新前端API端点
- 热重载前端服务

#### 查看当前状态
```bash
./switch-backend.sh status
```
- 显示当前后端端口
- 检查服务健康状态
- 显示前端配置信息

#### 回滚配置
```bash
./switch-backend.sh rollback dev_20240101_120000
```
- 恢复之前的前端配置
- 热重载前端服务
- 验证配置正确性

### 3. 高可用模式

#### 启动高可用模式
```bash
./start-advanced.sh start-ha dev
```
- 启动主后端服务（端口7102）
- 启动备份后端服务（自动分配端口）
- 配置Nginx负载均衡
- 启动前端服务

#### 监控服务状态
```bash
./start-advanced.sh monitor
```
- 实时显示服务状态
- 自动刷新状态信息
- 支持Ctrl+C退出

## 配置说明

### Nginx负载均衡配置

脚本会自动生成Nginx配置：

```nginx
upstream yibang_backend {
    server 127.0.0.1:7102 weight=3 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:7103 weight=1 max_fails=3 fail_timeout=30s backup;
    keepalive 32;
}
```

### 前端配置更新

脚本会自动更新前端配置文件：

```typescript
// frontend/src/utils/request.ts
const service = axios.create({
  baseURL: 'http://localhost:7103', // 自动更新端口
  timeout: 10000
})
```

### 端口管理

- **7102**：默认主服务端口
- **7103**：备份服务端口
- **7104**：迁移服务端口
- **8080**：健康检查端口

## 故障排查

### 常见问题

1. **端口被占用**
   ```bash
   # 检查端口占用
   lsof -i :7102
   
   # 停止占用端口的服务
   ./start-backend-migration.sh stop-all
   ```

2. **Nginx配置错误**
   ```bash
   # 测试Nginx配置
   sudo nginx -t
   
   # 重新加载Nginx
   sudo systemctl reload nginx
   ```

3. **后端健康检查失败**
   ```bash
   # 测试后端连接
   ./switch-backend.sh test 7102
   
   # 查看后端日志
   tail -f backend-7102.log
   ```

4. **前端配置未更新**
   ```bash
   # 检查前端配置
   ./switch-backend.sh status
   
   # 手动更新配置
   ./switch-backend.sh 7103 dev
   ```

### 日志文件

- `backend-7102.log`：主服务日志
- `backend-7103.log`：备份服务日志
- `backend-7104.log`：迁移服务日志
- `frontend.log`：前端服务日志

### 状态文件

- `primary.port`：当前主服务端口
- `backup.port`：备份服务端口
- `migration.port`：迁移服务端口
- `old.port`：旧服务端口
- `current.backend.port`：当前后端端口

## 最佳实践

### 1. 迁移前准备
- 确保新后端服务健康
- 备份当前配置
- 通知相关人员

### 2. 迁移过程
- 使用健康检查验证服务
- 逐步切换流量
- 监控服务状态

### 3. 迁移后验证
- 验证所有功能正常
- 检查日志无错误
- 确认性能正常

### 4. 回滚准备
- 保留旧服务配置
- 准备快速回滚方案
- 监控关键指标

## 系统要求

### 软件要求
- Java 17+
- Node.js 18+
- Nginx 1.18+
- MySQL 8.0+
- Redis 7.0+

### 权限要求
- 脚本执行权限
- Nginx配置权限（sudo）
- 端口绑定权限

### 网络要求
- 本地回环访问
- 端口7102-7110可用
- 外部API访问（DeepSeek）

## 安全注意事项

1. **端口安全**：确保只有必要的端口对外开放
2. **配置备份**：定期备份配置文件
3. **日志监控**：监控异常日志
4. **权限控制**：限制脚本执行权限
5. **网络安全**：使用防火墙保护服务

## 性能优化

1. **连接池配置**：优化数据库连接池
2. **缓存策略**：合理使用Redis缓存
3. **负载均衡**：调整权重和超时设置
4. **监控指标**：监控关键性能指标

通过这套完整的后端迁移和切换系统，您可以实现：

- **零停机迁移**：服务迁移过程中用户无感知
- **快速故障恢复**：出现问题时快速切换后端
- **灵活部署**：支持多种部署模式
- **自动化管理**：减少人工操作错误
- **监控告警**：实时了解服务状态

这套系统特别适合生产环境中的高可用部署和故障恢复场景。
