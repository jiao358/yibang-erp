# 云服务器生产相关配置（登录 403 修复版）

## 运行环境
- Java: `/www/server/java/jdk-17.0.8/bin/java`（JDK 17）
- 后端端口: `7102`（无 context-path）
- 外部配置目录: `/opt/yibang-erp/config/`
- JAR 部署目录: `/opt/yibang-erp/`
- 前端静态目录: `/var/www/yibang-erp`
- 文件上传目录: `/opt/yibang-erp/uploads`
- 域名: `www.yibangkj.com`（HTTPS）

---

## systemd（`/etc/systemd/system/yibang-erp.service`）
```ini
[Unit]
Description=Yibang ERP Backend Service
After=network.target mysql.service redis.service

[Service]
Type=simple
User=root
Group=root
WorkingDirectory=/opt/yibang-erp
ExecStart=/www/server/java/jdk-17.0.8/bin/java -jar -Dspring.profiles.active=prod /opt/yibang-erp/yibang-erp-1.0.0.jar
ExecStop=/bin/kill -15 $MAINPID
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

---

## Spring Boot 外部配置（`/opt/yibang-erp/config/application-prod.yml`）
注意：不使用 context-path（`server.servlet.context-path` 必须注释/删除）。
```yaml
server:
  port: 7102
  servlet:
    # context-path: /api   # 必须保持注释

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/yibang_erp_prod?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: root
    password: Pino542635
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL57Dialect

  data:
    redis:
      host: localhost
      port: 6379
      database: 0
      timeout: 5000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0

logging:
  level:
    com.yibang.erp: INFO
    org.springframework: WARN
  file:
    name: /opt/yibang-erp/logs/yibang-erp.log
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

jwt:
  secret: prod-yibang-erp-super-secure-jwt-secret-key-2024-with-512-bits-minimum-security-requirement
  expiration: 86400000

file:
  upload:
    path: /opt/yibang-erp/uploads/
    image:
      max-size: 10MB
      allowed-types: jpg,jpeg,png,gif,webp
      path: images/products
    access:
      base-url: https://www.yibangkj.com/static/

management:
  endpoints:
    web:
      exposure:
        include: "health,info"
  endpoint:
    health:
      show-details: when-authorized
```

---

## Nginx 站点（`/www/server/panel/vhost/nginx/yibang-erp.conf`）
关键：`location /api/` 中 `proxy_pass` 不带 `/api/` 尾巴，确保原样透传 `/api` 给后端。
```nginx
server {
    listen 80;
    server_name www.yibangkj.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name www.yibangkj.com;

    ssl_certificate /www/server/nginx/conf/ssl/yibangkj.com_bundle.crt;
    ssl_certificate_key /www/server/nginx/conf/ssl/yibangkj.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    location /api/ {
        # 预检
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' 'https://www.yibangkj.com' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        add_header 'Access-Control-Allow-Origin' 'https://www.yibangkj.com' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;

        proxy_pass http://localhost:7102;   # 关键：不带 /api/
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        client_max_body_size 100M;
    }

    location /static/ {
        alias /opt/yibang-erp/uploads/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location / {
        root /var/www/yibang-erp;
        index index.html;
        try_files $uri $uri/ /index.html;

        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    access_log /www/wwwlogs/yibang-erp_access.log;
    error_log  /www/wwwlogs/yibang-erp_error.log;
}
```

---

## 目录与权限
```bash
# 前端静态目录
chown -R www:www /var/www/yibang-erp
find /var/www/yibang-erp -type d -exec chmod 755 {} \;
find /var/www/yibang-erp -type f -exec chmod 644 {} \;

# 上传目录
mkdir -p /opt/yibang-erp/uploads
chown -R root:root /opt/yibang-erp/uploads
find /opt/yibang-erp/uploads -type d -exec chmod 755 {} \;
find /opt/yibang-erp/uploads -type f -exec chmod 644 {} \;
```

---

## 部署/重启一步到位
```bash
systemctl stop yibang-erp
mv /opt/yibang-erp/yibang-erp-1.0.0.jar /opt/yibang-erp/yibang-erp-1.0.0.jar.backup.$(date +%F_%H%M%S)
mv /www/wwwroot/yibang-erp-1.0.0.jar /opt/yibang-erp/
chown root:root /opt/yibang-erp/yibang-erp-1.0.0.jar
chmod 644 /opt/yibang-erp/yibang-erp-1.0.0.jar
systemctl start yibang-erp
systemctl status yibang-erp --no-pager
```

---

## 验证（务必按顺序）
```bash
# Nginx
/www/server/nginx/sbin/nginx -t && /www/server/nginx/sbin/nginx -s reload

# 本机健康
curl -v http://localhost:7102/api/health | cat

# 本机登录
curl -v -X POST http://localhost:7102/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | cat

# 域名登录
curl -v -X POST https://www.yibangkj.com/api/auth/login \
  -H "Origin: https://www.yibangkj.com" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | cat
```

---

## 故障快速定位
```bash
# 启动失败原因
journalctl -u yibang-erp -n 200 --no-pager

# Security 路径判定
journalctl -u yibang-erp -n 200 --no-pager | grep -E "Securing|JWT认证过滤器" | tail -n 20

# 未残留 context-path（应无）
grep -Rin "context-path" /opt/yibang-erp/config || true

# Nginx 反代是否规范
grep -n "location /api/" /www/server/panel/vhost/nginx/yibang-erp.conf
grep -n "proxy_pass" /www/server/panel/vhost/nginx/yibang-erp.conf
```

---

## 核心要点（最终一致性）
- 生产环境不使用 context-path；控制器继续使用 `/api/...` 前缀；Nginx 原样透传 `/api` 到 7102。
- Security 放行 `"/api/auth/**"` 在 `"/api/**".authenticated()` 之前。
- 正确日志应出现：`Securing POST /api/auth/login` 与 `JWT认证过滤器 - 处理请求: POST /api/auth/login`。
