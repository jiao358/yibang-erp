# 传统部署方案

## 📋 部署概述

本文档详细说明如何将易邦ERP系统（前后端分离项目）部署到服务器上，使用传统部署方式，包含SSL证书配置。

## 🏗️ 服务器环境要求

### 系统要求
- 操作系统: Ubuntu 20.04+ / CentOS 7+ / RHEL 7+
- 内存: 最低4GB，推荐8GB+
- 存储: 最低20GB可用空间
- 网络: 公网IP，开放80、443、7102端口

### 软件要求
- Java 8 或 Java 11
- MySQL 5.7
- Redis 6.0+
- Nginx 1.18+

## 📦 第一步：本地打包

### 1.1 前端打包

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 检查构建结果
ls -la dist/
```

**输出结果**: `frontend/dist/` 目录包含所有静态文件

### 1.2 后端打包

```bash
# 进入后端目录
cd backend

# 清理并打包（跳过测试）
mvn clean package -DskipTests

# 检查构建结果
ls -la target/*.jar
```

**输出结果**: `backend/target/yibang-erp-*.jar` 文件

## 🖥️ 第二步：服务器环境准备

### 2.1 更新系统包

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 2.2 安装Java

```bash
# Ubuntu/Debian
sudo apt install openjdk-11-jdk -y

# CentOS/RHEL
sudo yum install java-11-openjdk-devel -y

# 验证安装
java -version
javac -version
```

### 2.3 安装MySQL 5.7

```bash
# Ubuntu/Debian
wget https://dev.mysql.com/get/mysql-apt-config_0.8.22-1_all.deb
sudo dpkg -i mysql-apt-config_0.8.22-1_all.deb
sudo apt update
sudo apt install mysql-server=5.7.39-1ubuntu18.04 -y

# CentOS/RHEL
sudo yum install https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm -y
sudo yum install mysql-community-server -y

# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

### 2.4 安装Redis

```bash
# Ubuntu/Debian
sudo apt install redis-server -y

# CentOS/RHEL
sudo yum install epel-release -y
sudo yum install redis -y

# 启动Redis服务
sudo systemctl start redis
sudo systemctl enable redis

# 验证Redis
redis-cli ping
```

### 2.5 安装Nginx

```bash
# Ubuntu/Debian
sudo apt install nginx -y

# CentOS/RHEL
sudo yum install nginx -y

# 启动Nginx服务
sudo systemctl start nginx
sudo systemctl enable nginx

# 验证Nginx
sudo nginx -t
```

## 🗄️ 第三步：数据库配置

### 3.1 创建数据库和用户

```bash
# 登录MySQL
mysql -u root -p

# 在MySQL中执行以下命令
CREATE DATABASE yibang_erp_dev CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'yibang_user'@'localhost' IDENTIFIED BY 'YourSecurePassword123!';
GRANT ALL PRIVILEGES ON yibang_erp_dev.* TO 'yibang_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 3.2 导入数据库结构

```bash
# 上传SQL文件到服务器（使用scp或sftp）
# 假设SQL文件已上传到 /tmp/sql/

# 执行数据库初始化脚本
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/01_users_tables.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/02_products_tables.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/03_orders_tables.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/04_ai_management_tables.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/05_dashboard_tables.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/06_gmv_analysis_tables.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/07_pricing_tables.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/08_message_tables.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/09_inventory_tables.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/09_monitoring_tables.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/09_multi_tenant_relationships.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/09_price_tier_enhancement.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/10_migration_script_mysql57.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/10_migration_script.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/10_product_price_tier_configs.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/11_order_templates_table.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/12_ai_excel_process_tables.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/13_ai_excel_error_orders_tables.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/14_product_images_table.sql
mysql -u yibang_user -p yibang_erp_dev < /tmp/sql/16_logistics_warehouse_fields.sql
```

## 📁 第四步：文件部署

### 4.1 创建部署目录

```bash
# 创建应用目录
sudo mkdir -p /opt/yibang-erp
sudo mkdir -p /var/www/yibang-erp
sudo mkdir -p /opt/yibang-erp/logs
sudo mkdir -p /opt/yibang-erp/config

# 设置权限
sudo chown -R www-data:www-data /var/www/yibang-erp
sudo chown -R yibang:yibang /opt/yibang-erp
```

### 4.2 上传前端文件

```bash
# 将本地打包的dist目录上传到服务器
# 使用scp命令（在本地执行）
scp -r frontend/dist/* user@server_ip:/var/www/yibang-erp/

# 或者使用rsync
rsync -avz frontend/dist/ user@server_ip:/var/www/yibang-erp/
```

### 4.3 上传后端文件

```bash
# 上传JAR文件
scp backend/target/yibang-erp-*.jar user@server_ip:/opt/yibang-erp/

# 上传配置文件
scp backend/src/main/resources/application-prod.yml user@server_ip:/opt/yibang-erp/config/
```

## ⚙️ 第五步：后端配置

### 5.1 修改生产环境配置

**文件**: `/opt/yibang-erp/config/application-prod.yml`

```yaml
server:
  port: 7102
  servlet:
    context-path: /api

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/yibang_erp_dev?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: yibang_user
    password: YourSecurePassword123!
    driver-class-name: com.mysql.cj.jdbc.Driver
    
  redis:
    host: localhost
    port: 6379
    password: 
    database: 0
    timeout: 5000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0

logging:
  level:
    com.yibang.erp: INFO
    org.springframework: WARN
  file:
    name: /opt/yibang-erp/logs/yibang-erp.log
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

### 5.2 创建systemd服务文件

**文件**: `/etc/systemd/system/yibang-erp.service`

```ini
[Unit]
Description=Yibang ERP Backend Service
After=network.target mysql.service redis.service

[Service]
Type=simple
User=yibang
Group=yibang
WorkingDirectory=/opt/yibang-erp
ExecStart=/usr/bin/java -jar -Dspring.profiles.active=prod /opt/yibang-erp/yibang-erp-*.jar
ExecStop=/bin/kill -15 $MAINPID
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

### 5.3 启动后端服务

```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start yibang-erp

# 设置开机自启
sudo systemctl enable yibang-erp

# 检查服务状态
sudo systemctl status yibang-erp

# 查看日志
sudo journalctl -u yibang-erp -f
```

## 🌐 第六步：Nginx配置

### 6.1 配置SSL证书

```bash
# 创建SSL证书目录
sudo mkdir -p /etc/nginx/ssl

# 上传SSL证书文件
# 将您的证书文件上传到以下位置：
# /etc/nginx/ssl/your-domain.crt (证书文件)
# /etc/nginx/ssl/your-domain.key (私钥文件)

# 设置证书文件权限
sudo chmod 600 /etc/nginx/ssl/your-domain.key
sudo chmod 644 /etc/nginx/ssl/your-domain.crt
```

### 6.2 配置Nginx虚拟主机

**文件**: `/etc/nginx/sites-available/yibang-erp`

```nginx
# 重定向HTTP到HTTPS
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS配置
server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL证书配置
    ssl_certificate /etc/nginx/ssl/your-domain.crt;
    ssl_certificate_key /etc/nginx/ssl/your-domain.key;
    
    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    
    # 前端静态文件
    location / {
        root /var/www/yibang-erp;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # 静态文件缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # 后端API代理
    location /api/ {
        proxy_pass http://localhost:7102;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 文件上传大小限制
        client_max_body_size 100M;
    }
    
    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### 6.3 启用Nginx配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/yibang-erp /etc/nginx/sites-enabled/

# 删除默认配置（可选）
sudo rm -f /etc/nginx/sites-enabled/default

# 测试Nginx配置
sudo nginx -t

# 重新加载Nginx
sudo systemctl reload nginx

# 检查Nginx状态
sudo systemctl status nginx
```

## 🔧 第七步：代码修改说明

### 7.1 前端代码修改

**文件**: `frontend/src/utils/request.ts`

```typescript
// 修改API基础URL为生产环境
const service = axios.create({
  baseURL: process.env.NODE_ENV === 'production' ? 'https://your-domain.com/api' : '',
  timeout: 15000,
  headers: {
    'Content-Type': 'application/json;charset=utf-8'
  }
})
```

**文件**: `frontend/vite.config.ts`

```typescript
export default defineConfig({
  plugins: [vue()],
  base: '/', // 确保基础路径正确
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    sourcemap: false, // 生产环境关闭sourcemap
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['vue', 'vue-router', 'element-plus'],
          utils: ['axios', 'dayjs']
        }
      }
    }
  }
})
```

### 7.2 后端代码修改

**文件**: `backend/src/main/resources/application.yml`

```yaml
spring:
  profiles:
    active: prod  # 设置默认激活生产环境配置
```

**文件**: `backend/src/main/resources/application-prod.yml`

```yaml
# 确保生产环境配置正确
server:
  port: 7102
  servlet:
    context-path: /api

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/yibang_erp_dev?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME:yibang_user}
    password: ${DB_PASSWORD:YourSecurePassword123!}
    
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
```

## 🔥 第八步：防火墙配置

```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 7102/tcp  # 后端API（如果需要直接访问）
sudo ufw enable

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-port=7102/tcp
sudo firewall-cmd --reload
```

## ✅ 第九步：部署验证

### 9.1 检查服务状态

```bash
# 检查所有服务状态
sudo systemctl status mysql
sudo systemctl status redis
sudo systemctl status nginx
sudo systemctl status yibang-erp

# 检查端口监听
sudo netstat -tlnp | grep -E ':(80|443|3306|6379|7102)'
```

### 9.2 测试访问

```bash
# 测试HTTP重定向
curl -I http://your-domain.com

# 测试HTTPS访问
curl -I https://your-domain.com

# 测试API接口
curl -I https://your-domain.com/api/health

# 测试数据库连接
mysql -u yibang_user -p -h localhost yibang_erp_dev -e "SELECT 1;"
```

### 9.3 浏览器访问测试

1. 访问 `https://your-domain.com`
2. 检查前端页面是否正常加载
3. 测试登录功能
4. 测试API接口调用

## 🚨 故障排除

### 常见问题及解决方案

**问题1: 后端服务启动失败**
```bash
# 查看详细日志
sudo journalctl -u yibang-erp -n 100

# 检查Java版本
java -version

# 检查端口占用
sudo netstat -tlnp | grep 7102
```

**问题2: 数据库连接失败**
```bash
# 检查MySQL服务
sudo systemctl status mysql

# 检查数据库用户权限
mysql -u root -p -e "SELECT User, Host FROM mysql.user WHERE User='yibang_user';"

# 测试数据库连接
mysql -u yibang_user -p -h localhost yibang_erp_dev
```

**问题3: Nginx配置错误**
```bash
# 测试Nginx配置
sudo nginx -t

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log

# 重新加载配置
sudo systemctl reload nginx
```

**问题4: SSL证书问题**
```bash
# 检查证书文件权限
ls -la /etc/nginx/ssl/

# 验证证书内容
openssl x509 -in /etc/nginx/ssl/your-domain.crt -text -noout

# 测试SSL配置
openssl s_client -connect your-domain.com:443 -servername your-domain.com
```

## 📋 部署检查清单

- [ ] 服务器环境准备完成
- [ ] MySQL 5.7安装并配置
- [ ] Redis安装并启动
- [ ] Java环境安装
- [ ] 数据库创建并导入结构
- [ ] 前端文件上传并配置
- [ ] 后端JAR文件上传
- [ ] 生产环境配置文件修改
- [ ] systemd服务配置
- [ ] SSL证书配置
- [ ] Nginx配置并启动
- [ ] 防火墙配置
- [ ] 服务启动验证
- [ ] 浏览器访问测试
- [ ] API接口测试

## 🔄 维护命令

```bash
# 重启所有服务
sudo systemctl restart mysql redis nginx yibang-erp

# 查看服务日志
sudo journalctl -u yibang-erp -f

# 更新应用（重新部署）
sudo systemctl stop yibang-erp
# 上传新的JAR文件
sudo systemctl start yibang-erp

# 备份数据库
mysqldump -u yibang_user -p yibang_erp_dev > backup_$(date +%Y%m%d_%H%M%S).sql
```

---

**部署完成！** 您的易邦ERP系统现在应该可以通过 `https://your-domain.com` 访问了。
