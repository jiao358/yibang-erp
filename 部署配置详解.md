# 部署配置详解

## 概述

本文档详细说明了易邦ERP系统在部署时的各种配置项，包括前端和后端的配置参数、作用说明以及对应的代码位置。

## 1. 后端配置

### 1.1 主配置文件

#### 1.1.1 application.yml (主配置)
**文件位置**: `backend/src/main/resources/application.yml`

**作用**: Spring Boot应用的主配置文件，定义了应用的基本配置

**主要配置项**:

```yaml
# 应用基本配置
spring:
  profiles:
    active: dev  # 激活的配置文件环境 (dev/test/prod)
  application:
    name: yibang-erp  # 应用名称
  output:
    ansi:
      enabled: NEVER  # 禁用ANSI输出，避免启动错误
      console-available: false
```

**代码位置**: 无直接代码对应，Spring Boot自动读取

#### 1.1.2 数据库配置
**配置位置**: `backend/src/main/resources/application.yml`

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver  # MySQL驱动
    hikari:
      maximum-pool-size: 20      # 最大连接池大小
      minimum-idle: 5            # 最小空闲连接数
      connection-timeout: 30000  # 连接超时时间(ms)
      idle-timeout: 600000       # 空闲超时时间(ms)
      max-lifetime: 1800000      # 连接最大生命周期(ms)
```

**代码位置**: 
- 数据源配置: `backend/src/main/java/com/yibang/erp/config/DataSourceConfig.java`
- 数据库连接: 所有使用`@Repository`注解的类

#### 1.1.3 Redis配置
**配置位置**: `backend/src/main/resources/application.yml`

```yaml
spring:
  data:
    redis:
      host: localhost        # Redis服务器地址
      port: 6379            # Redis端口
      database: 0           # Redis数据库编号
      timeout: 2000ms       # 连接超时时间
      lettuce:
        pool:
          max-active: 8     # 最大活跃连接数
          max-wait: -1ms    # 最大等待时间
          max-idle: 8       # 最大空闲连接数
          min-idle: 0       # 最小空闲连接数
```

**代码位置**: 
- Redis配置: `backend/src/main/java/com/yibang/erp/config/RedisConfig.java`
- 缓存使用: 使用`@Cacheable`注解的方法

#### 1.1.4 文件上传配置
**配置位置**: `backend/src/main/resources/application.yml`

```yaml
spring:
  servlet:
    multipart:
      max-file-size: 100MB      # 单个文件最大大小
      max-request-size: 100MB   # 请求最大大小
```

**代码位置**: 
- 文件上传处理: `backend/src/main/java/com/yibang/erp/controller/AIExcelOrderController.java`
- 文件上传组件: `frontend/src/views/ai/components/FileUpload.vue`

#### 1.1.5 服务器配置
**配置位置**: `backend/src/main/resources/application.yml`

```yaml
server:
  port: 7102  # 后端服务端口
```

**代码位置**: Spring Boot自动读取，无需代码配置

#### 1.1.6 日志配置
**配置位置**: `backend/src/main/resources/application.yml`

```yaml
logging:
  level:
    com.yibang.erp: DEBUG                    # 应用日志级别
    org.springframework.data.redis: DEBUG    # Redis日志级别
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

**代码位置**: 所有使用`log.info()`, `log.error()`等日志输出的类

#### 1.1.7 MyBatis Plus配置
**配置位置**: `backend/src/main/resources/application.yml`

```yaml
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true  # 下划线转驼峰
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl  # SQL日志输出
  global-config:
    db-config:
      logic-delete-field: deleted       # 逻辑删除字段
      logic-delete-value: 1            # 逻辑删除值
      logic-not-delete-value: 0        # 逻辑未删除值
```

**代码位置**: 
- MyBatis配置: `backend/src/main/java/com/yibang/erp/config/MybatisPlusConfig.java`
- 实体类: 所有继承`BaseEntity`的实体类

#### 1.1.8 JWT配置
**配置位置**: `backend/src/main/resources/application.yml`

```yaml
jwt:
  secret: yibang-erp-super-secure-jwt-secret-key-2024-with-512-bits-minimum-security-requirement-for-hmac-sha-algorithms
  expiration: 86400000  # Token过期时间(ms) - 24小时
```

**代码位置**: 
- JWT工具类: `backend/src/main/java/com/yibang/erp/util/JwtUtil.java`
- 安全配置: `backend/src/main/java/com/yibang/erp/config/SecurityConfig.java`
- 认证控制器: `backend/src/main/java/com/yibang/erp/controller/auth/AuthController.java`

#### 1.1.9 管理端点配置
**配置位置**: `backend/src/main/resources/application.yml`

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus  # 暴露的端点
  endpoint:
    health:
      show-details: always  # 显示健康检查详情
  health:
    redis:
      enabled: true         # 启用Redis健康检查
      timeout: 3000ms      # 健康检查超时时间
```

**代码位置**: 
- 健康检查: `backend/src/main/java/com/yibang/erp/controller/MonitorController.java`
- 监控端点: Spring Boot Actuator自动提供

#### 1.1.10 AI配置
**配置位置**: `backend/src/main/resources/application.yml`

```yaml
ai:
  deepseek:
    base-url: https://api.deepseek.com                    # DeepSeek API地址
    api-key: sk-3f69c84d8322422498438badd98cdac3         # API密钥
    default-model: deepseek-chat                          # 默认模型
    max-tokens: 4096                                      # 最大token数
    temperature: 0.7                                      # 温度参数
    enabled: true                                         # 是否启用
    timeout: 30000                                        # 超时时间(ms)
```

**代码位置**: 
- AI服务: `backend/src/main/java/com/yibang/erp/domain/service/impl/AIServiceImpl.java`
- AI配置类: `backend/src/main/java/com/yibang/erp/config/AIConfig.java`
- AI控制器: `backend/src/main/java/com/yibang/erp/controller/AIController.java`

### 1.2 环境特定配置

#### 1.2.1 开发环境配置 (application-dev.yml)
**文件位置**: `backend/src/main/resources/application-dev.yml`

**作用**: 开发环境特定配置，如数据库连接、调试设置等

**主要配置**:
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/yibang_erp?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: your_password
  data:
    redis:
      host: localhost
      port: 6379
      password: # 开发环境通常不需要密码
```

#### 1.2.2 测试环境配置 (application-test.yml)
**文件位置**: `backend/src/main/resources/application-test.yml`

**作用**: 测试环境配置，用于集成测试和功能测试

#### 1.2.3 生产环境配置 (application-prod.yml)
**文件位置**: `backend/src/main/resources/application-prod.yml`

**作用**: 生产环境配置，包含生产数据库、Redis等配置

**主要配置**:
```yaml
spring:
  datasource:
    url: jdbc:mysql://prod-db-host:3306/yibang_erp?useUnicode=true&characterEncoding=utf8&useSSL=true&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME:prod_user}
    password: ${DB_PASSWORD:prod_password}
  data:
    redis:
      host: ${REDIS_HOST:prod-redis-host}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:prod_redis_password}

logging:
  level:
    com.yibang.erp: INFO  # 生产环境使用INFO级别
    org.springframework.data.redis: WARN
```

### 1.3 安全配置

#### 1.3.1 Spring Security配置
**文件位置**: `backend/src/main/java/com/yibang/erp/config/SecurityConfig.java`

**作用**: 配置Spring Security，定义认证和授权规则

**主要配置**:
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    // 配置HTTP安全规则
    // 配置认证管理器
    // 配置密码编码器
    // 配置JWT过滤器
}
```

**关键配置项**:
- 公开访问的接口路径
- 需要认证的接口路径
- 角色权限映射
- JWT Token验证

#### 1.3.2 CORS配置
**文件位置**: `backend/src/main/java/com/yibang/erp/config/CorsConfig.java`

**作用**: 配置跨域资源共享，允许前端访问后端API

**主要配置**:
```java
@Configuration
public class CorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        // 配置允许的源
        // 配置允许的方法
        // 配置允许的头部
        // 配置是否允许凭证
    }
}
```

## 2. 前端配置

### 2.1 Vite配置

#### 2.1.1 vite.config.ts
**文件位置**: `frontend/vite.config.ts`

**作用**: Vite构建工具配置，定义开发服务器、构建选项等

**主要配置**:
```typescript
export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')  // 路径别名
    }
  },
  server: {
    port: 7101,                    // 开发服务器端口
    host: '0.0.0.0',              // 允许外部访问
    open: true,                   // 自动打开浏览器
    proxy: {
      '/api': {
        target: 'http://localhost:7102',  // 代理到后端服务
        changeOrigin: true,
        secure: false
      }
    }
  },
  build: {
    outDir: 'dist',               // 构建输出目录
    assetsDir: 'assets',          // 静态资源目录
    sourcemap: false,             // 是否生成sourcemap
    rollupOptions: {
      output: {
        chunkFileNames: 'js/[name]-[hash].js',      // JS文件命名
        entryFileNames: 'js/[name]-[hash].js',      // 入口文件命名
        assetFileNames: '[ext]/[name]-[hash].[ext]' // 资源文件命名
      }
    }
  }
})
```

**代码位置**: Vite构建工具自动读取

### 2.2 环境配置

#### 2.2.1 开发环境配置
**配置位置**: `frontend/vite.config.ts` 中的 `server.proxy`

**作用**: 开发环境下的API代理配置

**配置说明**:
```typescript
proxy: {
  '/api': {
    target: 'http://localhost:7102',  // 后端服务地址
    changeOrigin: true,               // 改变请求头中的origin
    secure: false                     // 是否验证SSL证书
  }
}
```

#### 2.2.2 生产环境配置
**配置位置**: 构建后的静态文件部署配置

**作用**: 生产环境下的API请求配置

**配置说明**:
- 需要配置Nginx或其他Web服务器
- 设置API请求的代理规则
- 配置静态资源缓存策略

### 2.3 请求配置

#### 2.3.1 请求拦截器配置
**文件位置**: `frontend/src/utils/request.ts`

**作用**: 配置Axios请求拦截器，处理认证、错误等

**主要配置**:
```typescript
// 请求拦截器
service.interceptors.request.use(
  (config) => {
    // 添加认证Token
    const token = localStorage.getItem('token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// 响应拦截器
service.interceptors.response.use(
  (response) => {
    return response.data
  },
  (error) => {
    // 处理认证错误
    if (error.response?.status === 401) {
      localStorage.removeItem('token')
      window.location.href = '/login'
    }
    return Promise.reject(error)
  }
)
```

**代码位置**: 所有使用`request`工具类的API调用

### 2.4 路由配置

#### 2.4.1 路由定义
**文件位置**: `frontend/src/router/index.ts`

**作用**: 定义前端路由规则和权限控制

**主要配置**:
```typescript
const routes = [
  {
    path: '/',
    name: 'MainLayout',
    component: MainLayout,
    meta: {
      requiresAuth: true  // 需要认证
    },
    children: [
      {
        path: 'dashboard',
        name: 'Dashboard',
        component: () => import('@/views/dashboard/Dashboard.vue'),
        meta: {
          title: '仪表板',
          requiresAuth: true
        }
      }
    ]
  }
]
```

**代码位置**: 路由守卫在`router/index.ts`中定义

### 2.5 状态管理配置

#### 2.5.1 Pinia配置
**文件位置**: `frontend/src/store/`

**作用**: 全局状态管理配置

**主要配置**:
- 用户状态管理
- 应用状态管理
- 缓存状态管理

## 3. 数据库配置

### 3.1 数据库初始化脚本

#### 3.1.1 DDL脚本
**文件位置**: `database/init/ddl/`

**作用**: 数据库表结构定义

**主要文件**:
- `01_users_tables.sql` - 用户相关表
- `02_products_tables.sql` - 产品相关表
- `03_orders_tables.sql` - 订单相关表
- `04_ai_management_tables.sql` - AI管理相关表
- `05_dashboard_tables.sql` - 仪表板相关表
- `06_gmv_analysis_tables.sql` - GMV分析相关表
- `07_pricing_tables.sql` - 定价相关表
- `08_message_tables.sql` - 消息相关表
- `09_inventory_tables.sql` - 库存相关表
- `10_migration_script.sql` - 数据迁移脚本
- `11_order_templates_table.sql` - 订单模板表
- `12_ai_excel_process_tables.sql` - AI Excel处理表
- `13_ai_excel_error_orders_tables.sql` - AI Excel错误订单表

#### 3.1.2 DML脚本
**文件位置**: `database/init/dml/`

**作用**: 初始数据插入

**主要文件**:
- `insert_qingdao_beer_brand.sql` - 青岛啤酒品牌数据

### 3.2 数据库连接配置

#### 3.2.1 开发环境
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/yibang_erp?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: your_password
```

#### 3.2.2 生产环境
```yaml
spring:
  datasource:
    url: jdbc:mysql://prod-db-host:3306/yibang_erp?useUnicode=true&characterEncoding=utf8&useSSL=true&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
```

## 4. 部署配置

### 4.1 Docker配置

#### 4.1.1 开发环境 Docker Compose
**文件位置**: `docker/docker-compose-dev.yml`

**作用**: 开发环境的Docker容器编排（仅用于开发，生产环境不推荐）

**主要配置**:
```yaml
version: '3.8'
services:
  # 开发环境可以使用Docker MySQL，但生产环境不推荐
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: yibang_erp
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/init:/docker-entrypoint-initdb.d

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  backend:
    build: ./backend
    ports:
      - "7102:7102"
    depends_on:
      - mysql
      - redis
    environment:
      SPRING_PROFILES_ACTIVE: dev
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: yibang_erp
      DB_USERNAME: root
      DB_PASSWORD: root_password
      REDIS_HOST: redis
      REDIS_PORT: 6379

  frontend:
    build: ./frontend
    ports:
      - "7101:80"
    depends_on:
      - backend

volumes:
  mysql_data:
  redis_data:
```

#### 4.1.2 生产环境 Docker Compose（推荐）
**文件位置**: `docker/docker-compose-prod.yml`

**作用**: 生产环境容器编排，MySQL和Redis使用外部服务

**主要配置**:
```yaml
version: '3.8'
services:
  # 生产环境：后端应用容器
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "7102:7102"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      # 连接外部MySQL数据库
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-3306}
      DB_NAME: ${DB_NAME}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      # 连接外部Redis
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      # JWT配置
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400000}
      # AI配置
      AI_DEEPSEEK_API_KEY: ${AI_DEEPSEEK_API_KEY}
      AI_DEEPSEEK_BASE_URL: ${AI_DEEPSEEK_BASE_URL:-https://api.deepseek.com}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7102/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 生产环境：前端应用容器
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "7101:80"
    depends_on:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 可选：Redis容器（如果不想使用外部Redis）
  # redis:
  #   image: redis:7-alpine
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data
  #   restart: unless-stopped
  #   command: redis-server --requirepass ${REDIS_PASSWORD}

# volumes:
#   redis_data:
```

#### 4.1.3 生产环境环境变量文件
**文件位置**: `.env.prod`

**作用**: 生产环境的环境变量配置

**主要配置**:
```bash
# 数据库配置（外部MySQL）
DB_HOST=your-mysql-host.com
DB_PORT=3306
DB_NAME=yibang_erp
DB_USERNAME=yibang_user
DB_PASSWORD=your_secure_password

# Redis配置（外部Redis或容器Redis）
REDIS_HOST=your-redis-host.com
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password

# JWT配置
JWT_SECRET=your-super-secure-jwt-secret-key-with-512-bits-minimum
JWT_EXPIRATION=86400000

# AI配置
AI_DEEPSEEK_API_KEY=your-deepseek-api-key
AI_DEEPSEEK_BASE_URL=https://api.deepseek.com

# 应用配置
SPRING_PROFILES_ACTIVE=prod
SERVER_PORT=7102
```

### 4.2 传统部署方案（推荐生产环境）

#### 4.2.1 服务器架构
**推荐架构**:
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Nginx (80/443)│    │  Spring Boot    │    │   MySQL 8.0     │
│   (前端+代理)    │────│   (7102)        │────│   (3306)        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                       ┌─────────────────┐
                       │   Redis 7.0     │
                       │   (6379)        │
                       └─────────────────┘
```

#### 4.2.2 服务器要求
**最低配置**:
- CPU: 2核心
- 内存: 4GB
- 硬盘: 50GB SSD
- 操作系统: Ubuntu 20.04+ / CentOS 8+

**推荐配置**:
- CPU: 4核心
- 内存: 8GB
- 硬盘: 100GB SSD
- 操作系统: Ubuntu 22.04 LTS

#### 4.2.3 系统软件安装
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Java 17
sudo apt install openjdk-17-jdk -y

# 安装MySQL 8.0
sudo apt install mysql-server-8.0 -y

# 安装Redis
sudo apt install redis-server -y

# 安装Nginx
sudo apt install nginx -y

# 安装Node.js 18+ (用于构建前端)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install nodejs -y

# 安装PM2 (进程管理)
sudo npm install -g pm2
```

#### 4.2.4 MySQL配置
**配置文件**: `/etc/mysql/mysql.conf.d/mysqld.cnf`

```ini
[mysqld]
# 基本配置
port = 3306
bind-address = 127.0.0.1
max_connections = 200
max_connect_errors = 1000

# 字符集配置
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# 性能优化
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2

# 二进制日志
log-bin = mysql-bin
binlog_format = ROW
expire_logs_days = 7
```

**数据库初始化**:
```bash
# 创建数据库和用户
sudo mysql -u root -p
```

```sql
-- 创建数据库
CREATE DATABASE yibang_erp CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'yibang_user'@'localhost' IDENTIFIED BY 'your_secure_password';
CREATE USER 'yibang_user'@'127.0.0.1' IDENTIFIED BY 'your_secure_password';

-- 授权
GRANT ALL PRIVILEGES ON yibang_erp.* TO 'yibang_user'@'localhost';
GRANT ALL PRIVILEGES ON yibang_erp.* TO 'yibang_user'@'127.0.0.1';

-- 刷新权限
FLUSH PRIVILEGES;
```

**导入数据库结构**:
```bash
# 导入DDL脚本
mysql -u yibang_user -p yibang_erp < database/init/ddl/01_users_tables.sql
mysql -u yibang_user -p yibang_erp < database/init/ddl/02_products_tables.sql
mysql -u yibang_user -p yibang_erp < database/init/ddl/03_orders_tables.sql
# ... 导入其他DDL脚本

# 导入初始数据
mysql -u yibang_user -p yibang_erp < database/init/dml/insert_qingdao_beer_brand.sql
```

#### 4.2.5 Redis配置
**配置文件**: `/etc/redis/redis.conf`

```conf
# 基本配置
bind 127.0.0.1
port 6379
timeout 300
tcp-keepalive 60

# 内存配置
maxmemory 512mb
maxmemory-policy allkeys-lru

# 持久化配置
save 900 1
save 300 10
save 60 10000

# 安全配置
requirepass your_redis_password

# 日志配置
loglevel notice
logfile /var/log/redis/redis-server.log
```

#### 4.2.6 后端应用部署
**构建JAR包**:
```bash
# 在项目根目录
cd backend
./mvnw clean package -DskipTests

# 生成的JAR包位置
ls -la target/yibang-erp-*.jar
```

**创建应用目录**:
```bash
# 创建应用目录
sudo mkdir -p /opt/yibang-erp
sudo mkdir -p /opt/yibang-erp/logs
sudo mkdir -p /opt/yibang-erp/uploads

# 复制JAR包
sudo cp target/yibang-erp-*.jar /opt/yibang-erp/app.jar

# 设置权限
sudo chown -R yibang:yibang /opt/yibang-erp
```

**创建应用配置文件**:
**文件位置**: `/opt/yibang-erp/application-prod.yml`

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/yibang_erp?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: yibang_user
    password: your_secure_password
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  data:
    redis:
      host: localhost
      port: 6379
      password: your_redis_password
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-wait: -1ms
          max-idle: 8
          min-idle: 0

  servlet:
    multipart:
      max-file-size: 100MB
      max-request-size: 100MB

server:
  port: 7102

logging:
  level:
    com.yibang.erp: INFO
    org.springframework.data.redis: WARN
  file:
    name: /opt/yibang-erp/logs/yibang-erp.log
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  logback:
    rollingpolicy:
      max-file-size: 100MB
      max-history: 30
      total-size-cap: 1GB

jwt:
  secret: your-super-secure-jwt-secret-key-with-512-bits-minimum
  expiration: 86400000

ai:
  deepseek:
    base-url: https://api.deepseek.com
    api-key: your-deepseek-api-key
    default-model: deepseek-chat
    max-tokens: 4096
    temperature: 0.7
    enabled: true
    timeout: 30000
```

**创建systemd服务文件**:
**文件位置**: `/etc/systemd/system/yibang-erp.service`

```ini
[Unit]
Description=Yibang ERP Backend Service
After=network.target mysql.service redis.service

[Service]
Type=simple
User=yibang
Group=yibang
WorkingDirectory=/opt/yibang-erp
ExecStart=/usr/bin/java -Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar app.jar --spring.profiles.active=prod
ExecStop=/bin/kill -15 $MAINPID
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=yibang-erp

[Install]
WantedBy=multi-user.target
```

**启动服务**:
```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start yibang-erp

# 设置开机自启
sudo systemctl enable yibang-erp

# 检查服务状态
sudo systemctl status yibang-erp

# 查看日志
sudo journalctl -u yibang-erp -f
```

#### 4.2.7 前端应用部署
**构建前端**:
```bash
# 在项目根目录
cd frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 构建产物在 dist/ 目录
ls -la dist/
```

**部署到Nginx**:
```bash
# 创建前端目录
sudo mkdir -p /var/www/yibang-erp

# 复制构建产物
sudo cp -r dist/* /var/www/yibang-erp/

# 设置权限
sudo chown -R www-data:www-data /var/www/yibang-erp
```

### 4.3 Nginx配置

#### 4.3.1 完整Nginx配置
**文件位置**: `/etc/nginx/sites-available/yibang-erp`

**作用**: 前端静态文件服务和API代理

**主要配置**:
```nginx
# 上游后端服务配置
upstream yibang_backend {
    server 127.0.0.1:7102;
    keepalive 32;
}

# HTTP服务器配置
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS服务器配置
server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL证书配置
    ssl_certificate /etc/ssl/certs/your-domain.crt;
    ssl_certificate_key /etc/ssl/private/your-domain.key;
    
    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 安全头配置
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # 前端静态文件
    location / {
        root /var/www/yibang-erp;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # 静态资源缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API代理配置
    location /api {
        proxy_pass http://yibang_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时配置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # 缓冲配置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # 文件上传大小限制
    client_max_body_size 100M;
    
    # 访问日志
    access_log /var/log/nginx/yibang-erp-access.log;
    error_log /var/log/nginx/yibang-erp-error.log;
}

# 健康检查端点
server {
    listen 8080;
    server_name localhost;
    
    location /health {
        proxy_pass http://127.0.0.1:7102/actuator/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### 4.3.2 启用Nginx配置
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/yibang-erp /etc/nginx/sites-enabled/

# 删除默认配置
sudo rm /etc/nginx/sites-enabled/default

# 测试配置
sudo nginx -t

# 重新加载Nginx
sudo systemctl reload nginx

# 设置开机自启
sudo systemctl enable nginx
```

#### 4.3.3 SSL证书配置（Let's Encrypt）
```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取SSL证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 设置自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

### 4.3 环境变量配置

#### 4.3.1 后端环境变量
**配置位置**: 系统环境变量或Docker环境变量

**主要变量**:
```bash
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=yibang_erp
DB_USERNAME=root
DB_PASSWORD=your_password

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password

# JWT配置
JWT_SECRET=your-jwt-secret-key
JWT_EXPIRATION=86400000

# AI配置
AI_DEEPSEEK_API_KEY=your-deepseek-api-key
AI_DEEPSEEK_BASE_URL=https://api.deepseek.com

# 应用配置
SPRING_PROFILES_ACTIVE=prod
SERVER_PORT=7102
```

#### 4.3.2 前端环境变量
**配置位置**: 构建时环境变量

**主要变量**:
```bash
# API基础URL
VITE_API_BASE_URL=https://your-api-domain.com/api

# 应用配置
VITE_APP_TITLE=易邦ERP系统
VITE_APP_VERSION=1.0.0
```

## 5. 监控配置

### 5.1 应用监控

#### 5.1.1 Spring Boot Actuator
**配置位置**: `backend/src/main/resources/application.yml`

**作用**: 应用健康检查和监控端点

**主要配置**:
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
```

**访问地址**:
- 健康检查: `http://localhost:7102/actuator/health`
- 应用信息: `http://localhost:7102/actuator/info`
- 指标数据: `http://localhost:7102/actuator/metrics`
- Prometheus: `http://localhost:7102/actuator/prometheus`

#### 5.1.2 自定义监控
**文件位置**: `backend/src/main/java/com/yibang/erp/controller/MonitorController.java`

**作用**: 自定义系统监控接口

**主要功能**:
- 系统信息采集
- JVM指标监控
- 数据库状态监控
- 服务健康检查

## 6. 日志配置

### 6.1 日志级别配置

#### 6.1.1 开发环境
```yaml
logging:
  level:
    com.yibang.erp: DEBUG
    org.springframework.data.redis: DEBUG
    org.springframework.security: DEBUG
```

#### 6.1.2 生产环境
```yaml
logging:
  level:
    com.yibang.erp: INFO
    org.springframework.data.redis: WARN
    org.springframework.security: WARN
```

### 6.2 日志文件配置

#### 6.2.1 文件输出配置
```yaml
logging:
  file:
    name: logs/yibang-erp.log
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  logback:
    rollingpolicy:
      max-file-size: 100MB
      max-history: 30
      total-size-cap: 1GB
```

## 7. 安全配置

### 7.1 HTTPS配置

#### 7.1.1 SSL证书配置
**配置位置**: 服务器SSL证书配置

**作用**: 启用HTTPS加密传输

**主要配置**:
```yaml
server:
  port: 443
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: your_keystore_password
    key-store-type: PKCS12
    key-alias: tomcat
```

### 7.2 防火墙配置

#### 7.2.1 端口开放
**配置位置**: 服务器防火墙配置

**需要开放的端口**:
- 80 (HTTP)
- 443 (HTTPS)
- 7101 (前端开发服务器)
- 7102 (后端服务)
- 3306 (MySQL，仅内网)
- 6379 (Redis，仅内网)

## 8. 性能优化配置

### 8.1 数据库连接池优化

#### 8.1.1 HikariCP配置
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000
```

### 8.2 Redis缓存优化

#### 8.2.1 Redis连接池配置
```yaml
spring:
  data:
    redis:
      lettuce:
        pool:
          max-active: 8
          max-wait: -1ms
          max-idle: 8
          min-idle: 0
```

### 8.3 JVM优化

#### 8.3.1 JVM参数配置
```bash
# 内存配置
-Xms2g -Xmx4g

# GC配置
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200

# 其他优化
-XX:+UseStringDeduplication
-XX:+OptimizeStringConcat
```

## 9. 部署检查清单

### 9.1 部署前检查

#### 9.1.1 服务器环境检查
- [ ] 操作系统版本符合要求（Ubuntu 20.04+ / CentOS 8+）
- [ ] 服务器硬件配置满足最低要求
- [ ] 网络连接正常
- [ ] 防火墙配置正确
- [ ] 域名解析配置正确

#### 9.1.2 软件安装检查
- [ ] Java 17 安装完成
- [ ] MySQL 8.0 安装完成
- [ ] Redis 7.0 安装完成
- [ ] Nginx 安装完成
- [ ] Node.js 18+ 安装完成（用于构建前端）

#### 9.1.3 数据库配置检查
- [ ] MySQL服务启动正常
- [ ] 数据库创建成功
- [ ] 数据库用户创建成功
- [ ] 数据库权限配置正确
- [ ] DDL脚本导入成功
- [ ] 初始数据导入成功

#### 9.1.4 Redis配置检查
- [ ] Redis服务启动正常
- [ ] Redis密码配置正确
- [ ] Redis内存配置合理
- [ ] Redis持久化配置正确

#### 9.1.5 应用配置检查
- [ ] 数据库连接配置正确
- [ ] Redis连接配置正确
- [ ] JWT密钥配置安全
- [ ] AI API密钥配置正确
- [ ] 文件上传路径配置正确
- [ ] 日志输出路径配置正确
- [ ] SSL证书配置正确（生产环境）

### 9.2 部署后验证

#### 9.2.1 服务状态检查
- [ ] MySQL服务运行正常
- [ ] Redis服务运行正常
- [ ] Nginx服务运行正常
- [ ] 后端应用服务运行正常

#### 9.2.2 功能验证
- [ ] 前端页面访问正常
- [ ] 用户登录功能正常
- [ ] API接口访问正常
- [ ] 数据库连接正常
- [ ] Redis连接正常
- [ ] 文件上传功能正常
- [ ] 用户认证功能正常
- [ ] AI Excel导入功能正常

#### 9.2.3 性能验证
- [ ] 页面加载速度正常
- [ ] API响应时间正常
- [ ] 数据库查询性能正常
- [ ] 内存使用率正常
- [ ] CPU使用率正常

#### 9.2.4 安全验证
- [ ] HTTPS访问正常
- [ ] SSL证书有效
- [ ] 安全头配置正确
- [ ] 防火墙规则正确
- [ ] 数据库访问受限

#### 9.2.5 监控验证
- [ ] 应用健康检查正常
- [ ] 日志输出正常
- [ ] 监控端点访问正常
- [ ] 错误日志无异常

### 9.3 生产环境部署脚本

#### 9.3.1 一键部署脚本
**文件位置**: `deploy.sh`

```bash
#!/bin/bash

# 易邦ERP生产环境一键部署脚本
set -e

echo "开始部署易邦ERP系统..."

# 检查是否为root用户
if [ "$EUID" -ne 0 ]; then
    echo "请使用root用户运行此脚本"
    exit 1
fi

# 1. 更新系统
echo "更新系统包..."
apt update && apt upgrade -y

# 2. 安装必要软件
echo "安装必要软件..."
apt install -y openjdk-17-jdk mysql-server-8.0 redis-server nginx curl wget

# 3. 配置MySQL
echo "配置MySQL..."
systemctl start mysql
systemctl enable mysql

# 4. 配置Redis
echo "配置Redis..."
systemctl start redis-server
systemctl enable redis-server

# 5. 创建应用用户
echo "创建应用用户..."
useradd -r -s /bin/false yibang || true

# 6. 创建应用目录
echo "创建应用目录..."
mkdir -p /opt/yibang-erp/{logs,uploads}
chown -R yibang:yibang /opt/yibang-erp

# 7. 配置Nginx
echo "配置Nginx..."
systemctl start nginx
systemctl enable nginx

echo "基础环境部署完成！"
echo "请继续执行以下步骤："
echo "1. 配置MySQL数据库和用户"
echo "2. 导入数据库结构"
echo "3. 部署后端应用"
echo "4. 部署前端应用"
echo "5. 配置SSL证书"
```

#### 9.3.2 数据库初始化脚本
**文件位置**: `init-database.sh`

```bash
#!/bin/bash

# 数据库初始化脚本
set -e

echo "初始化数据库..."

# 读取数据库配置
read -p "请输入MySQL root密码: " -s MYSQL_ROOT_PASSWORD
echo
read -p "请输入应用数据库用户名: " DB_USER
read -p "请输入应用数据库密码: " -s DB_PASSWORD
echo

# 创建数据库和用户
mysql -u root -p$MYSQL_ROOT_PASSWORD << EOF
CREATE DATABASE IF NOT EXISTS yibang_erp CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';
CREATE USER IF NOT EXISTS '$DB_USER'@'127.0.0.1' IDENTIFIED BY '$DB_PASSWORD';
GRANT ALL PRIVILEGES ON yibang_erp.* TO '$DB_USER'@'localhost';
GRANT ALL PRIVILEGES ON yibang_erp.* TO '$DB_USER'@'127.0.0.1';
FLUSH PRIVILEGES;
EOF

echo "数据库初始化完成！"
```

#### 9.3.3 应用部署脚本
**文件位置**: `deploy-app.sh`

```bash
#!/bin/bash

# 应用部署脚本
set -e

echo "部署应用..."

# 检查JAR包是否存在
if [ ! -f "backend/target/yibang-erp-*.jar" ]; then
    echo "请先构建后端应用"
    exit 1
fi

# 检查前端构建产物是否存在
if [ ! -d "frontend/dist" ]; then
    echo "请先构建前端应用"
    exit 1
fi

# 部署后端
echo "部署后端应用..."
cp backend/target/yibang-erp-*.jar /opt/yibang-erp/app.jar
chown yibang:yibang /opt/yibang-erp/app.jar

# 部署前端
echo "部署前端应用..."
cp -r frontend/dist/* /var/www/yibang-erp/
chown -R www-data:www-data /var/www/yibang-erp

# 重启服务
echo "重启服务..."
systemctl restart yibang-erp
systemctl reload nginx

echo "应用部署完成！"
```

## 10. 故障排查

### 10.1 常见问题

#### 10.1.1 数据库连接失败
**可能原因**:
- 数据库服务未启动
- 连接参数配置错误
- 网络连接问题
- 数据库用户权限不足

**排查方法**:
- 检查数据库服务状态
- 验证连接参数
- 测试网络连通性
- 检查用户权限

#### 10.1.2 Redis连接失败
**可能原因**:
- Redis服务未启动
- 连接参数配置错误
- 网络连接问题
- Redis密码错误

**排查方法**:
- 检查Redis服务状态
- 验证连接参数
- 测试网络连通性
- 检查Redis密码

#### 10.1.3 JWT认证失败
**可能原因**:
- JWT密钥配置错误
- Token过期
- Token格式错误
- 用户权限不足

**排查方法**:
- 检查JWT密钥配置
- 验证Token有效性
- 检查Token格式
- 验证用户权限

### 10.2 日志分析

#### 10.2.1 应用日志
**日志位置**: `logs/yibang-erp.log`

**关键日志**:
- 应用启动日志
- 错误异常日志
- 数据库操作日志
- 用户操作日志

#### 10.2.2 系统日志
**日志位置**: 系统日志目录

**关键日志**:
- 系统启动日志
- 网络连接日志
- 安全审计日志
- 性能监控日志

## 总结

本文档详细说明了易邦ERP系统的各种配置项，包括：

1. **后端配置**: Spring Boot应用配置、数据库配置、Redis配置、安全配置等
2. **前端配置**: Vite构建配置、请求配置、路由配置等
3. **数据库配置**: 表结构定义、初始数据、连接配置等
4. **部署配置**: Docker配置、Nginx配置、环境变量等
5. **监控配置**: 应用监控、系统监控、日志配置等
6. **安全配置**: HTTPS配置、防火墙配置、认证配置等
7. **性能优化**: 连接池优化、缓存优化、JVM优化等

通过正确配置这些参数，可以确保系统在不同环境下稳定运行，并提供良好的性能和安全性。
