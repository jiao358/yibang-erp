<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Excel ç¼“å­˜ä»»åŠ¡è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #409eff;
        }
        .button {
            background: #409eff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 4px;
            font-size: 14px;
        }
        .button:hover {
            background: #66b1ff;
        }
        .button.danger {
            background: #f56c6c;
        }
        .button.danger:hover {
            background: #f78989;
        }
        .button.success {
            background: #67c23a;
        }
        .button.success:hover {
            background: #85ce61;
        }
        .info-box {
            background: #f4f4f5;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status.processing {
            background: #e1f3d8;
            color: #67c23a;
        }
        .status.completed {
            background: #e1f3d8;
            color: #67c23a;
        }
        .status.failed {
            background: #fde2e2;
            color: #f56c6c;
        }
        .status.system-processing {
            background: #e6f7ff;
            color: #1890ff;
        }
        .status.pending {
            background: #fff7e6;
            color: #fa8c16;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ AI Excel ç¼“å­˜ä»»åŠ¡è°ƒè¯•å·¥å…·</h1>
        <p>ç”¨äºè°ƒè¯•å’Œä¿®å¤AI Excelå¯¼å…¥æ¨¡å—çš„è™šæ‹Ÿä»»åŠ¡ç¼“å­˜é—®é¢˜</p>
    </div>

    <div class="container">
        <div class="section-title">ğŸ“‹ å½“å‰ç¼“å­˜ä»»åŠ¡çŠ¶æ€</div>
        <button class="button" onclick="loadCacheStatus()">åˆ·æ–°çŠ¶æ€</button>
        <button class="button success" onclick="clearExpiredTasks()">æ¸…ç†è¿‡æœŸä»»åŠ¡</button>
        <button class="button danger" onclick="clearAllTasks()">æ¸…ç†æ‰€æœ‰ç¼“å­˜ä»»åŠ¡</button>
        <div id="cacheStatus" class="info-box">ç‚¹å‡»"åˆ·æ–°çŠ¶æ€"æŸ¥çœ‹å½“å‰ç¼“å­˜ä»»åŠ¡</div>
    </div>

    <div class="container">
        <div class="section-title">ğŸ” ä»»åŠ¡çŠ¶æ€åˆ†æ</div>
        <button class="button" onclick="analyzeTasks()">åˆ†æä»»åŠ¡çŠ¶æ€</button>
        <button class="button" onclick="checkProcessingTasks()">æ£€æŸ¥å¤„ç†ä¸­ä»»åŠ¡</button>
        <div id="taskAnalysis" class="info-box">ç‚¹å‡»"åˆ†æä»»åŠ¡çŠ¶æ€"æŸ¥çœ‹è¯¦ç»†åˆ†æ</div>
    </div>

    <div class="container">
        <div class="section-title">ğŸ› ï¸ ä¿®å¤æ“ä½œ</div>
        <button class="button success" onclick="fixCacheIssues()">è‡ªåŠ¨ä¿®å¤ç¼“å­˜é—®é¢˜</button>
        <button class="button" onclick="simulateTaskCompletion()">æ¨¡æ‹Ÿä»»åŠ¡å®Œæˆ</button>
        <button class="button" onclick="testUploadBlock()">æµ‹è¯•ä¸Šä¼ é˜»æ­¢</button>
        <div id="fixResults" class="info-box">ç‚¹å‡»ç›¸åº”æŒ‰é’®æ‰§è¡Œä¿®å¤æ“ä½œ</div>
    </div>

    <div class="container">
        <div class="section-title">ğŸ“Š è°ƒè¯•ä¿¡æ¯</div>
        <button class="button" onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
        <button class="button" onclick="exportDebugData()">å¯¼å‡ºè°ƒè¯•æ•°æ®</button>
        <div id="debugInfo" class="info-box">ç‚¹å‡»"æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯"æŸ¥çœ‹è¯¦ç»†è°ƒè¯•æ•°æ®</div>
    </div>

    <script>
        const CACHED_TASKS_KEY = 'aiExcelCachedTasks';
        
        // åŠ è½½ç¼“å­˜çŠ¶æ€
        function loadCacheStatus() {
            try {
                const cachedTasks = loadCachedTasks();
                const statusDiv = document.getElementById('cacheStatus');
                
                if (cachedTasks.length === 0) {
                    statusDiv.textContent = 'âœ… æ²¡æœ‰ç¼“å­˜ä»»åŠ¡';
                    return;
                }
                
                let status = `ğŸ“‹ æ‰¾åˆ° ${cachedTasks.length} ä¸ªç¼“å­˜ä»»åŠ¡:\n\n`;
                
                cachedTasks.forEach((task, index) => {
                    const statusClass = getStatusClass(task.status);
                    status += `${index + 1}. ä»»åŠ¡ID: ${task.taskId}\n`;
                    status += `   æ–‡ä»¶å: ${task.fileName}\n`;
                    status += `   çŠ¶æ€: <span class="status ${statusClass}">${task.status}</span>\n`;
                    status += `   åˆ›å»ºæ—¶é—´: ${task.createdAt}\n`;
                    status += `   æ˜¯å¦ç¼“å­˜: ${task.isCached ? 'æ˜¯' : 'å¦'}\n`;
                    status += `   æ–‡ä»¶å¤§å°: ${formatFileSize(task.fileSize || 0)}\n`;
                    status += `   ä¸Šä¼ ç”¨æˆ·: ${task.uploadUser || 'æœªçŸ¥'}\n`;
                    status += `   ä¾›åº”å•†: ${task.supplier || 'æœªçŸ¥'}\n\n`;
                });
                
                statusDiv.innerHTML = status;
            } catch (error) {
                document.getElementById('cacheStatus').textContent = `âŒ åŠ è½½ç¼“å­˜çŠ¶æ€å¤±è´¥: ${error.message}`;
            }
        }
        
        // åˆ†æä»»åŠ¡çŠ¶æ€
        function analyzeTasks() {
            try {
                const cachedTasks = loadCachedTasks();
                const analysisDiv = document.getElementById('taskAnalysis');
                
                if (cachedTasks.length === 0) {
                    analysisDiv.textContent = 'âœ… æ²¡æœ‰ä»»åŠ¡éœ€è¦åˆ†æ';
                    return;
                }
                
                const statusCounts = {};
                const expiredTasks = [];
                const now = new Date().getTime();
                
                cachedTasks.forEach(task => {
                    // ç»Ÿè®¡çŠ¶æ€
                    statusCounts[task.status] = (statusCounts[task.status] || 0) + 1;
                    
                    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                    const taskTime = new Date(task.createdAt).getTime();
                    const hoursDiff = (now - taskTime) / (1000 * 60 * 60);
                    if (hoursDiff >= 1) {
                        expiredTasks.push(task);
                    }
                });
                
                let analysis = `ğŸ“Š ä»»åŠ¡çŠ¶æ€åˆ†æ:\n\n`;
                analysis += `æ€»ä»»åŠ¡æ•°: ${cachedTasks.length}\n`;
                analysis += `è¿‡æœŸä»»åŠ¡æ•°: ${expiredTasks.length}\n\n`;
                
                analysis += `çŠ¶æ€åˆ†å¸ƒ:\n`;
                Object.entries(statusCounts).forEach(([status, count]) => {
                    analysis += `  ${status}: ${count} ä¸ª\n`;
                });
                
                if (expiredTasks.length > 0) {
                    analysis += `\nè¿‡æœŸä»»åŠ¡:\n`;
                    expiredTasks.forEach(task => {
                        const taskTime = new Date(task.createdAt).getTime();
                        const hoursDiff = (now - taskTime) / (1000 * 60 * 60);
                        analysis += `  - ${task.taskId} (${hoursDiff.toFixed(1)}å°æ—¶å‰)\n`;
                    });
                }
                
                analysisDiv.textContent = analysis;
            } catch (error) {
                document.getElementById('taskAnalysis').textContent = `âŒ åˆ†æå¤±è´¥: ${error.message}`;
            }
        }
        
        // æ£€æŸ¥å¤„ç†ä¸­ä»»åŠ¡
        function checkProcessingTasks() {
            try {
                const cachedTasks = loadCachedTasks();
                const processingTasks = cachedTasks.filter(task => 
                    task.status === 'PROCESSING' || 
                    task.status === 'SYSTEM_PROCESSING' ||
                    task.status === 'PENDING'
                );
                
                const analysisDiv = document.getElementById('taskAnalysis');
                
                if (processingTasks.length === 0) {
                    analysisDiv.textContent = 'âœ… æ²¡æœ‰å¤„ç†ä¸­çš„ä»»åŠ¡ï¼Œå¯ä»¥æ­£å¸¸ä¸Šä¼ æ–°æ–‡ä»¶';
                    return;
                }
                
                let analysis = `âš ï¸ å‘ç° ${processingTasks.length} ä¸ªå¤„ç†ä¸­çš„ä»»åŠ¡:\n\n`;
                
                processingTasks.forEach((task, index) => {
                    analysis += `${index + 1}. ${task.taskId} (${task.status})\n`;
                    analysis += `   æ–‡ä»¶å: ${task.fileName}\n`;
                    analysis += `   åˆ›å»ºæ—¶é—´: ${task.createdAt}\n`;
                    analysis += `   æ˜¯å¦ç¼“å­˜: ${task.isCached ? 'æ˜¯' : 'å¦'}\n\n`;
                });
                
                analysis += `è¿™äº›ä»»åŠ¡ä¼šé˜»æ­¢æ–°æ–‡ä»¶ä¸Šä¼ ã€‚\n`;
                analysis += `å»ºè®®æ¸…ç†è¿™äº›ä»»åŠ¡æˆ–ç­‰å¾…å®ƒä»¬å®Œæˆã€‚`;
                
                analysisDiv.textContent = analysis;
            } catch (error) {
                document.getElementById('taskAnalysis').textContent = `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`;
            }
        }
        
        // è‡ªåŠ¨ä¿®å¤ç¼“å­˜é—®é¢˜
        function fixCacheIssues() {
            try {
                const resultsDiv = document.getElementById('fixResults');
                let results = 'ğŸ”§ å¼€å§‹è‡ªåŠ¨ä¿®å¤...\n\n';
                
                // 1. æ¸…ç†è¿‡æœŸä»»åŠ¡
                const cachedTasks = loadCachedTasks();
                const now = new Date().getTime();
                const validTasks = cachedTasks.filter(task => {
                    const taskTime = new Date(task.createdAt).getTime();
                    const hoursDiff = (now - taskTime) / (1000 * 60 * 60);
                    return hoursDiff < 1;
                });
                
                if (validTasks.length !== cachedTasks.length) {
                    localStorage.setItem(CACHED_TASKS_KEY, JSON.stringify(validTasks));
                    results += `âœ… æ¸…ç†äº† ${cachedTasks.length - validTasks.length} ä¸ªè¿‡æœŸä»»åŠ¡\n`;
                } else {
                    results += `âœ… æ²¡æœ‰è¿‡æœŸä»»åŠ¡éœ€è¦æ¸…ç†\n`;
                }
                
                // 2. æ£€æŸ¥å¤„ç†ä¸­ä»»åŠ¡
                const processingTasks = validTasks.filter(task => 
                    task.status === 'PROCESSING' || 
                    task.status === 'SYSTEM_PROCESSING' ||
                    task.status === 'PENDING'
                );
                
                if (processingTasks.length > 0) {
                    results += `âš ï¸ å‘ç° ${processingTasks.length} ä¸ªå¤„ç†ä¸­ä»»åŠ¡ï¼Œå»ºè®®æ‰‹åŠ¨æ¸…ç†\n`;
                    results += `å¤„ç†ä¸­ä»»åŠ¡ID: ${processingTasks.map(t => t.taskId).join(', ')}\n`;
                } else {
                    results += `âœ… æ²¡æœ‰å¤„ç†ä¸­ä»»åŠ¡\n`;
                }
                
                // 3. æ£€æŸ¥ä»»åŠ¡æ•°é‡
                if (validTasks.length > 10) {
                    const limitedTasks = validTasks.slice(0, 10);
                    localStorage.setItem(CACHED_TASKS_KEY, JSON.stringify(limitedTasks));
                    results += `âœ… é™åˆ¶ç¼“å­˜ä»»åŠ¡æ•°é‡ä¸º10ä¸ª\n`;
                } else {
                    results += `âœ… ç¼“å­˜ä»»åŠ¡æ•°é‡æ­£å¸¸ (${validTasks.length}ä¸ª)\n`;
                }
                
                results += `\nğŸ‰ ä¿®å¤å®Œæˆï¼`;
                resultsDiv.textContent = results;
                
                // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
                setTimeout(loadCacheStatus, 500);
            } catch (error) {
                document.getElementById('fixResults').textContent = `âŒ ä¿®å¤å¤±è´¥: ${error.message}`;
            }
        }
        
        // æ¸…ç†è¿‡æœŸä»»åŠ¡
        function clearExpiredTasks() {
            try {
                const cachedTasks = loadCachedTasks();
                const now = new Date().getTime();
                const validTasks = cachedTasks.filter(task => {
                    const taskTime = new Date(task.createdAt).getTime();
                    const hoursDiff = (now - taskTime) / (1000 * 60 * 60);
                    return hoursDiff < 1;
                });
                
                if (validTasks.length !== cachedTasks.length) {
                    localStorage.setItem(CACHED_TASKS_KEY, JSON.stringify(validTasks));
                    document.getElementById('fixResults').textContent = `âœ… å·²æ¸…ç† ${cachedTasks.length - validTasks.length} ä¸ªè¿‡æœŸä»»åŠ¡`;
                } else {
                    document.getElementById('fixResults').textContent = `âœ… æ²¡æœ‰è¿‡æœŸä»»åŠ¡éœ€è¦æ¸…ç†`;
                }
                
                setTimeout(loadCacheStatus, 500);
            } catch (error) {
                document.getElementById('fixResults').textContent = `âŒ æ¸…ç†å¤±è´¥: ${error.message}`;
            }
        }
        
        // æ¸…ç†æ‰€æœ‰ç¼“å­˜ä»»åŠ¡
        function clearAllTasks() {
            if (confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰ç¼“å­˜ä»»åŠ¡å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰è™šæ‹Ÿä»»åŠ¡ã€‚')) {
                try {
                    localStorage.removeItem(CACHED_TASKS_KEY);
                    document.getElementById('fixResults').textContent = `âœ… å·²æ¸…ç†æ‰€æœ‰ç¼“å­˜ä»»åŠ¡`;
                    setTimeout(loadCacheStatus, 500);
                } catch (error) {
                    document.getElementById('fixResults').textContent = `âŒ æ¸…ç†å¤±è´¥: ${error.message}`;
                }
            }
        }
        
        // æ¨¡æ‹Ÿä»»åŠ¡å®Œæˆ
        function simulateTaskCompletion() {
            try {
                const cachedTasks = loadCachedTasks();
                const processingTasks = cachedTasks.filter(task => 
                    task.status === 'PROCESSING' || 
                    task.status === 'SYSTEM_PROCESSING' ||
                    task.status === 'PENDING'
                );
                
                if (processingTasks.length === 0) {
                    document.getElementById('fixResults').textContent = `âœ… æ²¡æœ‰å¤„ç†ä¸­ä»»åŠ¡éœ€è¦æ¨¡æ‹Ÿå®Œæˆ`;
                    return;
                }
                
                // å°†å¤„ç†ä¸­ä»»åŠ¡æ ‡è®°ä¸ºå®Œæˆ
                const updatedTasks = cachedTasks.map(task => {
                    if (task.status === 'PROCESSING' || 
                        task.status === 'SYSTEM_PROCESSING' ||
                        task.status === 'PENDING') {
                        return { ...task, status: 'COMPLETED' };
                    }
                    return task;
                });
                
                localStorage.setItem(CACHED_TASKS_KEY, JSON.stringify(updatedTasks));
                document.getElementById('fixResults').textContent = `âœ… å·²æ¨¡æ‹Ÿ ${processingTasks.length} ä¸ªä»»åŠ¡å®Œæˆ`;
                
                setTimeout(loadCacheStatus, 500);
            } catch (error) {
                document.getElementById('fixResults').textContent = `âŒ æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•ä¸Šä¼ é˜»æ­¢
        function testUploadBlock() {
            try {
                const cachedTasks = loadCachedTasks();
                const processingTasks = cachedTasks.filter(task => 
                    task.status === 'PROCESSING' || 
                    task.status === 'SYSTEM_PROCESSING' ||
                    task.status === 'PENDING'
                );
                
                const resultsDiv = document.getElementById('fixResults');
                
                if (processingTasks.length > 0) {
                    resultsDiv.textContent = `âš ï¸ ä¸Šä¼ è¢«é˜»æ­¢ï¼å‘ç° ${processingTasks.length} ä¸ªå¤„ç†ä¸­ä»»åŠ¡:\n${processingTasks.map(t => `- ${t.taskId} (${t.status})`).join('\n')}`;
                } else {
                    resultsDiv.textContent = `âœ… å¯ä»¥æ­£å¸¸ä¸Šä¼ æ–°æ–‡ä»¶`;
                }
            } catch (error) {
                document.getElementById('fixResults').textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo() {
            try {
                const debugDiv = document.getElementById('debugInfo');
                const cachedTasks = loadCachedTasks();
                
                let debug = `ğŸ” è°ƒè¯•ä¿¡æ¯:\n\n`;
                debug += `LocalStorage é”®å: ${CACHED_TASKS_KEY}\n`;
                debug += `ç¼“å­˜ä»»åŠ¡æ•°é‡: ${cachedTasks.length}\n`;
                debug += `å½“å‰æ—¶é—´: ${new Date().toISOString()}\n\n`;
                
                debug += `åŸå§‹ LocalStorage æ•°æ®:\n`;
                const rawData = localStorage.getItem(CACHED_TASKS_KEY);
                debug += rawData || 'null';
                
                debugDiv.textContent = debug;
            } catch (error) {
                document.getElementById('debugInfo').textContent = `âŒ è·å–è°ƒè¯•ä¿¡æ¯å¤±è´¥: ${error.message}`;
            }
        }
        
        // å¯¼å‡ºè°ƒè¯•æ•°æ®
        function exportDebugData() {
            try {
                const cachedTasks = loadCachedTasks();
                const debugData = {
                    timestamp: new Date().toISOString(),
                    cachedTasks: cachedTasks,
                    localStorage: {
                        key: CACHED_TASKS_KEY,
                        value: localStorage.getItem(CACHED_TASKS_KEY)
                    }
                };
                
                const blob = new Blob([JSON.stringify(debugData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ai-excel-debug-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                document.getElementById('debugInfo').textContent = `âœ… è°ƒè¯•æ•°æ®å·²å¯¼å‡º`;
            } catch (error) {
                document.getElementById('debugInfo').textContent = `âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`;
            }
        }
        
        // å·¥å…·å‡½æ•°
        function loadCachedTasks() {
            try {
                const raw = localStorage.getItem(CACHED_TASKS_KEY);
                if (!raw) return [];
                const arr = JSON.parse(raw);
                return Array.isArray(arr) ? arr : [];
            } catch {
                return [];
            }
        }
        
        function getStatusClass(status) {
            switch (status) {
                case 'PROCESSING': return 'processing';
                case 'SYSTEM_PROCESSING': return 'system-processing';
                case 'COMPLETED': return 'completed';
                case 'FAILED': return 'failed';
                case 'PENDING': return 'pending';
                default: return 'processing';
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
        window.onload = function() {
            loadCacheStatus();
        };
    </script>
</body>
</html>
