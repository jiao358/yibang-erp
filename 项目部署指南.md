# 易邦ERP项目部署指南

## 概述

本指南将帮助您将易邦ERP项目打包并部署到服务器上。我们提供了自动化的打包和部署脚本，简化整个部署过程。

## 部署方式

### 方式1：一键部署（推荐）

```bash
# 完整部署流程（打包+上传+启动）
./package-and-deploy.sh deploy user@your-server.com
```

### 方式2：分步部署

```bash
# 1. 打包项目
./package-and-deploy.sh package prod

# 2. 上传到服务器
./package-and-deploy.sh upload packages/yibang-erp-20240101_120000.zip user@your-server.com

# 3. 启动服务
./package-and-deploy.sh start-remote user@your-server.com
```

## 详细步骤

### 1. 准备工作

#### 1.1 服务器要求
- **操作系统**: Ubuntu 20.04+ / CentOS 8+
- **硬件配置**: 2核4GB内存（最低）
- **软件要求**: Java 17+, Node.js 18+, MySQL 8.0+, Redis 7.0+

#### 1.2 本地环境要求
- **Java 17+**: 用于构建后端
- **Node.js 18+**: 用于构建前端
- **Maven**: 用于后端构建
- **SSH**: 用于服务器连接

#### 1.3 SSH配置
```bash
# 生成SSH密钥（如果没有）
ssh-keygen -t rsa -b 4096 -C "your-email@example.com"

# 复制公钥到服务器
ssh-copy-id user@your-server.com

# 测试SSH连接
ssh user@your-server.com "echo 'SSH连接成功'"
```

### 2. 服务器环境准备

#### 2.1 安装必要软件
```bash
# 连接到服务器
ssh user@your-server.com

# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Java 17
sudo apt install openjdk-17-jdk -y

# 安装Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install nodejs -y

# 安装MySQL 8.0
sudo apt install mysql-server-8.0 -y

# 安装Redis
sudo apt install redis-server -y

# 安装Nginx（可选，用于负载均衡）
sudo apt install nginx -y
```

#### 2.2 配置数据库
```bash
# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 创建数据库和用户
sudo mysql -u root -p
```

```sql
-- 创建数据库
CREATE DATABASE yibang_erp CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'yibang_user'@'localhost' IDENTIFIED BY 'your_secure_password';
CREATE USER 'yibang_user'@'127.0.0.1' IDENTIFIED BY 'your_secure_password';

-- 授权
GRANT ALL PRIVILEGES ON yibang_erp.* TO 'yibang_user'@'localhost';
GRANT ALL PRIVILEGES ON yibang_erp.* TO 'yibang_user'@'127.0.0.1';
FLUSH PRIVILEGES;
```

#### 2.3 配置Redis
```bash
# 启动Redis服务
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 配置Redis密码（可选）
sudo nano /etc/redis/redis.conf
# 添加: requirepass your_redis_password
sudo systemctl restart redis-server
```

### 3. 项目部署

#### 3.1 一键部署
```bash
# 在本地项目目录执行
./package-and-deploy.sh deploy user@your-server.com
```

这个命令会：
1. 自动构建后端和前端
2. 创建部署包
3. 上传到服务器
4. 解压并配置
5. 启动服务

#### 3.2 分步部署
```bash
# 步骤1: 打包项目
./package-and-deploy.sh package prod
# 输出: packages/yibang-erp-20240101_120000.zip

# 步骤2: 上传到服务器
./package-and-deploy.sh upload packages/yibang-erp-20240101_120000.zip user@your-server.com

# 步骤3: 启动服务
./package-and-deploy.sh start-remote user@your-server.com
```

### 4. 验证部署

#### 4.1 检查服务状态
```bash
# 检查远程服务状态
./package-and-deploy.sh status-remote user@your-server.com
```

#### 4.2 访问应用
- **前端**: http://your-server.com:7101
- **后端**: http://your-server.com:7102
- **健康检查**: http://your-server.com:7102/actuator/health

#### 4.3 检查日志
```bash
# 连接到服务器
ssh user@your-server.com

# 查看服务状态
cd /opt/yibang-erp/current
./start-all.sh status

# 查看日志
tail -f logs/backend.log
tail -f logs/frontend.log
```

## 部署模式

### 标准模式（默认）
```bash
./package-and-deploy.sh deploy user@your-server.com
```

### 高可用模式
```bash
./package-and-deploy.sh deploy user@your-server.com /opt/yibang-erp ha prod
```

## 配置文件

### 后端配置
部署后，后端配置文件位于：
- `/opt/yibang-erp/current/backend/src/main/resources/application-prod.yml`

主要配置项：
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/yibang_erp
    username: yibang_user
    password: your_secure_password
  data:
    redis:
      host: localhost
      port: 6379
      password: your_redis_password
```

### 前端配置
前端构建文件位于：
- `/opt/yibang-erp/current/frontend/dist/`

## 服务管理

### 启动服务
```bash
# 标准模式
./start-all.sh prod start

# 高可用模式
./start-advanced.sh start-ha prod
```

### 停止服务
```bash
./start-all.sh stop
```

### 重启服务
```bash
./start-all.sh restart prod
```

### 查看状态
```bash
./start-all.sh status
```

## 故障排查

### 常见问题

#### 1. SSH连接失败
```bash
# 检查SSH连接
ssh -v user@your-server.com

# 检查SSH密钥
ssh-add -l
```

#### 2. 服务启动失败
```bash
# 查看日志
tail -f logs/backend.log
tail -f logs/frontend.log

# 检查端口占用
netstat -tlnp | grep :7102
netstat -tlnp | grep :7101
```

#### 3. 数据库连接失败
```bash
# 检查MySQL服务
sudo systemctl status mysql

# 测试数据库连接
mysql -u yibang_user -p yibang_erp
```

#### 4. Redis连接失败
```bash
# 检查Redis服务
sudo systemctl status redis-server

# 测试Redis连接
redis-cli ping
```

### 日志文件位置
- 后端日志: `/opt/yibang-erp/current/logs/backend.log`
- 前端日志: `/opt/yibang-erp/current/logs/frontend.log`
- 系统日志: `/var/log/syslog`

## 备份和恢复

### 备份
```bash
# 备份数据库
mysqldump -u yibang_user -p yibang_erp > backup_$(date +%Y%m%d).sql

# 备份应用文件
tar -czf app_backup_$(date +%Y%m%d).tar.gz /opt/yibang-erp/current
```

### 恢复
```bash
# 恢复数据库
mysql -u yibang_user -p yibang_erp < backup_20240101.sql

# 恢复应用文件
tar -xzf app_backup_20240101.tar.gz -C /
```

## 性能优化

### 1. JVM优化
在启动脚本中调整JVM参数：
```bash
JVM_OPTS="-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
```

### 2. 数据库优化
```sql
-- 调整MySQL配置
SET GLOBAL innodb_buffer_pool_size = 1073741824; -- 1GB
SET GLOBAL max_connections = 200;
```

### 3. Redis优化
```bash
# 调整Redis配置
sudo nano /etc/redis/redis.conf
# 添加: maxmemory 512mb
# 添加: maxmemory-policy allkeys-lru
```

## 监控和维护

### 1. 健康检查
```bash
# 自动健康检查
curl http://localhost:7102/actuator/health

# 设置监控脚本
*/5 * * * * curl -f http://localhost:7102/actuator/health || echo "Service down" | mail -s "Alert" admin@example.com
```

### 2. 日志轮转
```bash
# 配置logrotate
sudo nano /etc/logrotate.d/yibang-erp
```

```
/opt/yibang-erp/current/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 yibang yibang
}
```

## 安全建议

### 1. 防火墙配置
```bash
# 只开放必要端口
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS
sudo ufw allow 7101  # 前端
sudo ufw allow 7102  # 后端
sudo ufw enable
```

### 2. 数据库安全
```bash
# 删除匿名用户
sudo mysql -u root -p
DELETE FROM mysql.user WHERE User='';
FLUSH PRIVILEGES;
```

### 3. 应用安全
- 使用强密码
- 定期更新依赖
- 启用HTTPS
- 配置安全头

## 总结

通过这套部署方案，您可以：

1. **一键部署**: 使用 `./package-and-deploy.sh deploy` 命令
2. **自动化构建**: 自动构建前端和后端
3. **自动配置**: 自动配置服务器环境
4. **服务管理**: 完整的服务生命周期管理
5. **监控维护**: 健康检查和日志管理

部署完成后，您的易邦ERP系统将在服务器上运行，提供稳定的服务。
